@using MudBlazor
@inherits LayoutComponentBase

<MudBlazor.MudThemeProvider @ref="_mudThemeProvider" @bind-IsDarkMode="_isDarkMode" Theme="Configuration.Theme" />
<MudBlazor.MudSnackbarProvider />

<AuthorizeView>
	<Authorized>
		<MudBlazor.MudLayout>
			<MudAppBar>
				<MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleDrawer" />
				Dima
				<MudSpacer />
				<MudText Typo="Typo.caption">
					@context.User.Identity?.Name
				</MudText>
				<MudSwitch @bind-Value="_isDarkMode" Color="Color.Inherit" Class="ma-4" T="bool" ThumbIcon="@Icons.Material.Filled.Lightbulb" />
			</MudAppBar>
			<MudDrawer @bind-Open="_isDrawerOpen">
				<h3>Nav Menu</h3>
			</MudDrawer>
			<MudBlazor.MudMainContent>
				<MudBlazor.MudContainer>
					@Body
				</MudBlazor.MudContainer>
			</MudBlazor.MudMainContent>
		</MudBlazor.MudLayout>
	</Authorized>
	<NotAuthorized>
		<LoginRedirect />
	</NotAuthorized>
</AuthorizeView>

@code {
	private bool _isDarkMode { get; set; } = true;
	private bool _isDrawerOpen { get; set; } = true;
	private MudThemeProvider _mudThemeProvider = null!;

	override protected async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			_isDarkMode = await _mudThemeProvider.GetSystemPreference();
			await _mudThemeProvider.WatchSystemDarkModeAsync(OnSystemPreferenceChanged);
			StateHasChanged();
		}
	}

	private Task OnSystemPreferenceChanged(bool newValue)
	{
		_isDarkMode = newValue;
		StateHasChanged();
		return Task.CompletedTask;
	}

	private void ToggleDrawer() => _isDrawerOpen = !_isDrawerOpen;

}